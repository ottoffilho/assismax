export interface ProductMention {
  product: string;
  category: 'basicos' | 'bebidas' | 'limpeza' | 'outros';
  urgency: 'alta' | 'media' | 'baixa';
}

export interface ConversationContext {
  stage: 'greeting' | 'introduction' | 'qualifying' | 'productDiscussion' | 'nameCapture' | 'contactCapture' | 'closing';
  hasGreeted: boolean;
  hasIntroduced: boolean;
  hasCapturedName: boolean;
  hasCapturedContact: boolean;
  productsMentioned: string[];
  urgencyLevel: 'alta' | 'media' | 'baixa' | null;
}

export const assistantPersonality = {
  name: "Assis",
  role: "Dono da AssisMax Atacarejo",
  
  greetings: [
    "Oi! Eu sou o Assis, dono aqui da AssisMax! üëã",
    "E a√≠! Assis aqui, propriet√°rio da AssisMax. Tudo bem?",
    "Ol√°! Prazer, sou o Assis, dono do atacarejo AssisMax!",
    "Opa! Assis falando, dono aqui da AssisMax. Como vai?"
  ],
  
  introductions: [
    "Aqui a gente trabalha diferente... Vendo no pre√ßo de atacado direto pra sua fam√≠lia! üõí",
    "Montei esse atacarejo pensando em ajudar as fam√≠lias daqui de Valpara√≠so a economizar de verdade.",
    "Sabe aquele pre√ßo bom de atacado? Aqui voc√™ compra assim, mesmo sendo pessoa f√≠sica!",
    "A AssisMax √© meu sonho realizado: atacarejo com pre√ßo justo pra todo mundo!"
  ],
  
  productInquiries: [
    "Me conta, o que voc√™ mais gasta todo m√™s? Arroz, feij√£o, √≥leo...? ü§î",
    "Qual produto pesa mais no seu or√ßamento? Quero te ajudar a economizar!",
    "O que sua fam√≠lia mais consome? Tenho √≥timos pre√ßos em produtos b√°sicos.",
    "T√¥ curioso... O que voc√™ t√° precisando comprar essa semana?"
  ],
  
  productResponses: {
    arroz: [
      "Arroz √© o que mais sai aqui! Tenho v√°rias marcas, desde o mais b√°sico at√© o premium, tudo no atacado. üåæ",
      "Ih, arroz eu tenho de monte! Trabalho com pacotes de 5kg com pre√ßo que voc√™ n√£o acha em mercado comum.",
      "Arroz aqui sai voando! Tenho tipo 1 e tipo 2, voc√™ economiza uns 30% f√°cil comprando comigo."
    ],
    feijao: [
      "Feij√£o carioquinha fresquinho! Compro direto do produtor, por isso o pre√ßo √© t√£o bom. ü´ò",
      "Tenho feij√£o de primeira! Pacotes de 1kg e 5kg, voc√™ escolhe. Pre√ßo de atacado mesmo!",
      "Feij√£o aqui √© sucesso! Carioquinha e preto, sempre novinho. Galera adora o pre√ßo."
    ],
    oleo: [
      "√ìleo de soja eu tenho das melhores marcas! Compra a caixa que sai bem mais barato. üõ¢Ô∏è",
      "√ìleo aqui √© no atacado mesmo! Vendo caixa fechada ou unidade, voc√™ que escolhe.",
      "No √≥leo voc√™ economiza MUITO comprando a caixa. Tenho Soya, Liza, Conc√≥rdia..."
    ],
    cafe: [
      "Caf√© eu tenho v√°rios! Desde o tradicional at√© os especiais. Pessoal daqui adora! ‚òï",
      "Caf√© fresquinho! Trabalho com marcas locais e as tradicionais tamb√©m. Pre√ßo √≥timo!",
      "Hmm caf√©! Tenho em p√≥ e em gr√£o. No atacado o pre√ßo fica bem interessante."
    ],
    leite: [
      "Leite integral, desnatado, em p√≥... Tenho de tudo! Caixas fechadas saem bem em conta. ü•õ",
      "Leite aqui vendo muito! Integral e desnatado, caixa com 12 unidades fica um pre√ß√£o.",
      "Trabalho com v√°rias marcas de leite. Compra por caixa que voc√™ economiza bastante!"
    ],
    bebidas: [
      "Bebidas tenho de tudo! Refrigerantes, sucos, √°guas... Tudo no pre√ßo de atacado! ü•§",
      "Na parte de bebidas sou forte! Coca, Guaran√°, sucos... Vendo fardo fechado ou unidade.",
      "Bebidas aqui tem muita variedade! E olha, tenho at√© umas cervejas e destilados com pre√ßo bom."
    ],
    geral: [
      "Tenho de tudo um pouco! Arroz, feij√£o, √≥leo, a√ß√∫car, caf√©, produtos de limpeza... üõçÔ∏è",
      "Trabalho com toda linha b√°sica! O que voc√™ precisar, provavelmente eu tenho no estoque.",
      "Aqui voc√™ encontra todos os b√°sicos pro m√™s! E tudo com pre√ßo de atacado, viu?"
    ]
  },
  
  nameCaptures: [
    "Ah, e qual seu nome? Gosto de conhecer meus clientes! üòä",
    "Me conta seu nome! Aqui a gente atende todo mundo pelo nome.",
    "E voc√™, como se chama? Sempre bom saber com quem t√¥ conversando!",
    "Qual seu nome mesmo? Quero te atender direitinho!"
  ],
  
  nameResponses: (name: string) => [
    `Prazer, ${name}! Seja muito bem-vindo(a) √† AssisMax! ü§ù`,
    `${name}! Que nome bonito! Fico feliz em te conhecer!`,
    `√ìtimo te conhecer, ${name}! Vou fazer o poss√≠vel pra te ajudar a economizar!`,
    `${name}, j√° anotei aqui! Voc√™ vai ver como os pre√ßos aqui s√£o diferentes!`
  ],
  
  contactCaptures: [
    "Posso te mandar os pre√ßos no WhatsApp? √â mais f√°cil e voc√™ fica com tudo registrado! üì±",
    "Me passa seu WhatsApp que eu mando a tabela de pre√ßos completa!",
    "Quer que eu envie os valores no seu WhatsApp? Assim voc√™ compara com calma.",
    "Se quiser, posso mandar tudo certinho no seu WhatsApp. Qual o n√∫mero?"
  ],
  
  contactResponses: [
    "Perfeito! J√° anotei seu contato. Vou pedir pra minha equipe te enviar tudo! üìù",
    "√ìtimo! Em alguns minutinhos voc√™ recebe nossa tabela completa no WhatsApp!",
    "Show! Voc√™ vai receber nossos pre√ßos e uma mensagem da equipe em breve!",
    "Pronto! Logo mais algu√©m da minha equipe vai entrar em contato com todos os detalhes!"
  ],
  
  closings: [
    "Foi √≥timo conversar com voc√™! Qualquer d√∫vida, pode chamar aqui ou no WhatsApp! üòä",
    "Espero te ver em breve aqui na loja! Fica ali na entrada de Valpara√≠so!",
    "Muito obrigado pelo contato! Tenho certeza que voc√™ vai gostar dos nossos pre√ßos!",
    "Um abra√ßo e at√© breve! A AssisMax t√° sempre de portas abertas pra voc√™!"
  ],
  
  fallbacks: [
    "Hmm, me conta mais! O que voc√™ t√° precisando comprar pro m√™s?",
    "Entendi! E al√©m disso, que outros produtos voc√™ costuma comprar?",
    "Legal! Aqui na AssisMax a gente tem de tudo. O que mais posso te ajudar?",
    "Interessante! Me fala mais sobre o que sua fam√≠lia consome no dia a dia."
  ],
  
  urgencyResponses: {
    alta: "Vi que voc√™ t√° precisando com urg√™ncia! Vou priorizar seu atendimento! ‚ö°",
    media: "Tranquilo! Vou garantir que voc√™ receba todas as informa√ß√µes hoje ainda!",
    baixa: "Sem pressa! Quando precisar, estaremos aqui com os melhores pre√ßos!"
  }
};

export function detectProducts(message: string): ProductMention[] {
  const lowerMessage = message.toLowerCase();
  const detectedProducts: ProductMention[] = [];
  
  const productKeywords = {
    arroz: { keywords: ['arroz', 'arros'], category: 'basicos' as const },
    feijao: { keywords: ['feij√£o', 'feijao', 'fej√£o', 'fejao'], category: 'basicos' as const },
    oleo: { keywords: ['√≥leo', 'oleo', 'azeite'], category: 'basicos' as const },
    cafe: { keywords: ['caf√©', 'cafe', 'cafezinho'], category: 'basicos' as const },
    leite: { keywords: ['leite'], category: 'basicos' as const },
    bebidas: { keywords: ['bebida', 'refrigerante', 'suco', 'cerveja', '√°gua', 'agua'], category: 'bebidas' as const },
    acucar: { keywords: ['a√ß√∫car', 'acucar'], category: 'basicos' as const },
    sal: { keywords: ['sal'], category: 'basicos' as const },
    macarrao: { keywords: ['macarr√£o', 'macarrao', 'massa'], category: 'basicos' as const },
    limpeza: { keywords: ['limpeza', 'detergente', 'sab√£o', 'sabao'], category: 'limpeza' as const }
  };
  
  Object.entries(productKeywords).forEach(([product, config]) => {
    if (config.keywords.some(keyword => lowerMessage.includes(keyword))) {
      detectedProducts.push({
        product,
        category: config.category,
        urgency: detectUrgency(lowerMessage)
      });
    }
  });
  
  return detectedProducts;
}

export function detectUrgency(message: string): 'alta' | 'media' | 'baixa' {
  const lowerMessage = message.toLowerCase();
  
  const highUrgencyWords = ['urgente', 'hoje', 'agora', 'acabou', 'acabando', 'preciso', 'necessito'];
  const mediumUrgencyWords = ['semana', 'pr√≥xima', 'proxima', 'precisando', 'comprando'];
  
  if (highUrgencyWords.some(word => lowerMessage.includes(word))) {
    return 'alta';
  }
  
  if (mediumUrgencyWords.some(word => lowerMessage.includes(word))) {
    return 'media';
  }
  
  return 'baixa';
}

export function extractName(message: string): string | null {
  const cleanMessage = message.trim();

  // Padr√µes para capturar nomes
  const patterns = [
    // "Meu nome √© Jo√£o Silva" ou "Meu nome √© Otto"
    /(?:meu nome √©|me chamo|sou o?a?|eu sou)\s+([A-Za-z√Ä-√ø\s]+?)(?:\s+e\s|\s+meu\s|\s+minha\s|$|\.|,)/i,
    // "Jo√£o Silva" no in√≠cio da mensagem (m√∫ltiplas palavras)
    /^([A-Za-z√Ä-√ø]+(?:\s+[A-Za-z√Ä-√ø]+)+)(?:\s+e\s|\s+meu\s|\s+minha\s|$|\.|,)/i,
    // Nome simples (uma palavra) - para casos como "otto"
    /^([A-Za-z√Ä-√ø]{2,})$/i
  ];

  for (const pattern of patterns) {
    const match = cleanMessage.match(pattern);
    if (match) {
      const potentialName = match[1].trim();

      // Verifica se parece ser um nome v√°lido
      if (potentialName.length >= 2 && potentialName.length <= 50 &&
          /^[A-Za-z√Ä-√ø\s]+$/.test(potentialName) &&
          !/(whatsapp|telefone|email|n√∫mero|celular|sim|n√£o|ok|oi|ol√°)/i.test(potentialName)) {
        return potentialName.split(' ').map(word =>
          word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        ).join(' ');
      }
    }
  }

  return null;
}

export function extractPhone(message: string): string | null {
  // Padr√µes para capturar telefones brasileiros
  const phonePatterns = [
    // (61) 99999-8888 ou (61) 9999-8888
    /\((\d{2})\)\s*(\d{4,5})[-.\s]?(\d{4})/g,
    // 61 99999-8888 ou 61 9999-8888
    /(\d{2})\s+(\d{4,5})[-.\s]?(\d{4})/g,
    // 6199999888 ou 61999998888
    /(\d{11}|\d{10})/g
  ];

  for (const pattern of phonePatterns) {
    const matches = [...message.matchAll(pattern)];
    for (const match of matches) {
      let phone = '';

      if (match[0].length >= 10) {
        // Remove todos os caracteres n√£o num√©ricos
        phone = match[0].replace(/\D/g, '');

        // Verifica se tem 10 ou 11 d√≠gitos
        if (phone.length === 10 || phone.length === 11) {
          // Formatar como (XX) XXXXX-XXXX ou (XX) XXXX-XXXX
          if (phone.length === 11) {
            return `(${phone.slice(0, 2)}) ${phone.slice(2, 7)}-${phone.slice(7)}`;
          } else {
            return `(${phone.slice(0, 2)}) ${phone.slice(2, 6)}-${phone.slice(6)}`;
          }
        }
      }
    }
  }

  return null;
}

export function getRandomResponse(responses: string[]): string {
  return responses[Math.floor(Math.random() * responses.length)];
}

export function shouldAskForName(context: ConversationContext, messageCount: number): boolean {
  return !context.hasCapturedName && 
         messageCount >= 3 && 
         (context.stage === 'productDiscussion' || context.stage === 'qualifying');
}

export function shouldAskForContact(context: ConversationContext): boolean {
  return context.hasCapturedName && 
         !context.hasCapturedContact && 
         context.productsMentioned.length > 0;
}